<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="report_invoice_lines">
        <t t-set="o" t-value="o.with_context({'lang':o.partner_id.lang})" />

        <!-- Is there a discount on at least one line? -->
        <t t-set="display_discount" t-value="any([l.discount for l in o.invoice_line_ids])"/>
        <!--
                    <div>STAMP</div>
                    <div t-if="'name' in o">FOUND FIELD NAME</div>
                    <div t-if="'name' not in o">NOT FOUND FIELD NAME</div>
                    <div><p t-esc="doc_opts.code_mode"/></div>
                    <div><p t-esc="doc_style.name"/></div>
        -->
        <table class="table table-condensed">
            <thead>
                <tr>
                    <th t-if="doc_opts.code_mode == 'print'">Codice</th>
                    <th>Descrizione</th>
                    <th class="hidden">Documento di origine</th>
                    <th class="text-right">Quantit√†</th>
                    <th class="text-right">Prezzo unitario</th>
                    <th t-if="display_discount" class="text-right">Sc.(%)</th>
                    <th class="text-right">IVA</th>
                    <th class="text-right">Totale riga</th>
                </tr>
            </thead>
            <t t-set="last_order" t-value="''"/>
            <t t-set="last_ddt" t-value="''"/>
            <tbody class="invoice_tbody">
                <tr t-foreach="o.invoice_line_ids" t-as="l">
                    <td t-if="doc_opts.code_mode == 'print'" style="vertical-align: bottom;"><span t-esc="l.code_2_print(doc_opts.code_mode)"/></td>
                    <td>
                        <t t-if="(l.sale_line_ids and last_order != l.sale_line_ids.order_id.client_order_ref) or (l.ddt_line_id and last_ddt != l.ddt_line_id.package_preparation_id.ddt_number)">
                            <p>
                                <t t-if="l.sale_line_ids and last_order != l.sale_line_ids.order_id.client_order_ref">
                                    <strong>Vs. Ordine: <span t-field="l.sale_line_ids.order_id.client_order_ref"/> - <span t-field="l.sale_line_ids.order_id.date_order" t-options="{'widget': 'date'}"/></strong>
                                    <t t-set="last_order" t-value="l.sale_line_ids.order_id.client_order_ref"/>
                                </t>
                                <t t-if="l.ddt_line_id and last_ddt != l.ddt_line_id.package_preparation_id.ddt_number">
                                    <strong>DdT: <span t-field="l.ddt_line_id.package_preparation_id.ddt_number"/> - <span t-field="l.ddt_line_id.package_preparation_id.date" t-options="{'widget': 'date'}"/></strong>
                                    <t t-set="last_ddt" t-value="l.ddt_line_id.package_preparation_id.ddt_number"/>
                                </t>
                            </p>
                        </t>
                    <span t-esc="l.description_2_print(doc_opts.code_mode)"/></td>
                    <td class="hidden"><span t-field="l.origin"/></td>
                    <td class="text-right" style="vertical-align: bottom;">
                        <span t-field="l.quantity"/>
                        <span t-field="l.uom_id" groups="product.group_uom"/>
                    </td>
                    <td class="text-right" style="vertical-align: bottom;">
                        <span t-field="l.price_unit"/>
                    </td>
                    <td t-if="display_discount" class="text-right" style="vertical-align: bottom;">
                        <span t-field="l.discount"/>
                    </td>
                    <td class="text-right" style="vertical-align: bottom;">
                        <span t-esc="', '.join(map(lambda x: (x.description or x.name), l.invoice_line_tax_ids))"/>
                    </td>
                    <td class="text-right" style="vertical-align: bottom;">
                        <span t-field="l.price_subtotal"
                              t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                    </td>
                </tr>
            </tbody>
        </table>
    </template>

</odoo>

